# Docker Compose - WaitTime Service
# Uses MQTT broker on port 1886 for client communication

version: '3.8'

services:
  mosquitto:
    image: eclipse-mosquitto:2.0
    container_name: waittime-mosquitto-broker
    ports:
      - "1886:1883"  # MQTT (port 1886 for client connections)
      - "9004:9001"  # WebSocket
    volumes:
      - ./mosquitto/config:/mosquitto/config
      - ./mosquitto/data:/mosquitto/data
      - ./mosquitto/log:/mosquitto/log
    networks:
      - waittime-network
    restart: unless-stopped

  waittime-service:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: waittime-service
    depends_on:
      - mosquitto
    environment:
      # MQTT Client broker (for publishing wait time updates to clients)
      MQTT_BROKER: mosquitto
      MQTT_PORT: 1883
      
      # Simulator broker (for receiving queue events from stadium simulator)
      SIMULATOR_BROKER: host.docker.internal
      SIMULATOR_PORT: 1883
      SIMULATOR_TOPIC: stadium/events/queues
      CLIENT_TOPIC: stadium/services/waittime
      
      # Service config
      SERVICE_PORT: 8001
      LOG_LEVEL: INFO
    ports:
      - "8001:8001"
    networks:
      - waittime-network
    restart: unless-stopped

networks:
  waittime-network:
    driver: bridge
