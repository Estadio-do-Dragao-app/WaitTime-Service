# Docker Compose - WaitTime Service
# Usa DOIS brokers MQTT separados

version: '3.8'

services:
  # Wait Time Service
  waittime-service:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: stadium-waittime-service
    environment:
      # DOWNSTREAM MQTT Broker (receives from simulator)
      DOWNSTREAM_BROKER_HOST: mosquitto-downstream
      DOWNSTREAM_BROKER_PORT: 1883
      DOWNSTREAM_TOPIC_QUEUES: stadium/events/queues
      DOWNSTREAM_TOPIC_ALL: stadium/events/all
      
      # UPSTREAM MQTT Broker (publishes to clients)
      UPSTREAM_BROKER_HOST: mosquitto-upstream
      UPSTREAM_BROKER_PORT: 1883
      UPSTREAM_TOPIC_PREFIX: stadium/waittime
      
      # PostgreSQL Database
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_DB: stadium_waittime
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      
      # Map Service
      MAP_SERVICE_URL: http://mapservice:8000
      
      # Service config
      SERVICE_PORT: 8001
      LOG_LEVEL: INFO
    ports:
      - "8001:8001"
    restart: unless-stopped
    networks:
      - stadium-network

  # DOWNSTREAM Mosquitto (receives events from simulator)
  mosquitto-downstream:
    image: eclipse-mosquitto:2
    container_name: stadium-mosquitto-downstream
    ports:
      - "1883:1883"
    command: mosquitto -c /mosquitto-no-auth.conf
    networks:
      - stadium-network

  # UPSTREAM Mosquitto (publishes to client apps)
  mosquitto-upstream:
    image: eclipse-mosquitto:2
    container_name: stadium-mosquitto-upstream
    ports:
      - "1884:1883"
    command: mosquitto -c /mosquitto-no-auth.conf
    networks:
      - stadium-network

networks:
  stadium-network:
    external: true

# NOTA:
# - DOWNSTREAM (porta 1883): Simulador publica eventos aqui
# - UPSTREAM (porta 1884): Clientes subscrevem wait times aqui
# - Para brokers externos, ajustar os hostnames nas vari√°veis de ambiente
